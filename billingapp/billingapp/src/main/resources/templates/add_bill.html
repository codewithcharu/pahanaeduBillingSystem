<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <title>Add Bill</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .bill-form {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .item-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .item-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.1);
        }
        .item-card.selected {
            border-color: #28a745;
            background-color: #f8fff9;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Create New Bill
                </h2>
                <a href="/bills" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Bills
                </a>
            </div>

            <!-- Success/Error Messages -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Error from URL parameter -->
            <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:if="${param.error == 'no_items'}">Please select at least one item to create a bill.</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="card bill-form">
                <div class="card-body">
                    <form th:action="@{/bills/save}" method="post" id="billForm">
                        
                        <!-- User Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-user me-2"></i>Select User:
                            </label>
                            <select name="userId" class="form-select" required>
                                <option value="">-- Select User --</option>
                                <option th:each="u : ${users}" 
                                        th:value="${u.id}" 
                                        th:text="${u.fullName + ' (' + u.username + ')'}">
                                </option>
  </select>
                        </div>

                        <!-- Items Selection -->
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <i class="fas fa-shopping-cart me-2"></i>Select Items and Quantity:
                            </h5>
                            
                            <div th:if="${#lists.isEmpty(items)}" class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No items found. Please add some items first.
                                <a href="/items" class="btn btn-sm btn-warning ms-2">Manage Items</a>
  </div>

                            <div th:each="item, iterStat : ${items}" class="item-card p-3 mb-3">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input item-checkbox" 
                                                   type="checkbox" 
                                                   th:name="'itemIds[' + ${iterStat.index} + ']'" 
                                                   th:value="${item.id}"
                                                   th:id="'item-' + ${item.id}"
                                                   onchange="toggleItemSelection(this, ${iterStat.index})" />
                                            <label class="form-check-label fw-bold" 
                                                   th:for="'item-' + ${item.id}"
                                                   th:text="${item.name}">
                                                Item Name
      </label>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-tag me-1"></i>
                                            Price: <span class="fw-bold" th:text="${'$' + #numbers.formatDecimal(item.price, 1, 2)}">$0.00</span>
                                        </small>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-boxes me-1"></i>
                                            Stock: <span class="fw-bold" th:text="${item.stock}">0</span> available
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-6">
                                                <label class="form-label">Quantity:</label>
                                                <input type="number" 
                                                       min="1" 
                                                       max="999"
                                                       value="1"
                                                       class="form-control quantity-input"
                                                       th:name="'quantities[' + ${iterStat.index} + ']'"
                                                       th:id="'quantity-' + ${iterStat.index}"
                                                       disabled
                                                       onchange="updateSubtotal(${iterStat.index}, ${item.price})" />
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Subtotal:</label>
                                                <div class="form-control-plaintext fw-bold text-success" 
                                                     th:id="'subtotal-' + ${iterStat.index}">
                                                    $0.00
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Total Amount Display -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6 offset-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5 class="mb-2">Total Amount</h5>
                                            <h3 class="text-primary mb-0" id="totalAmount">$0.00</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
  </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i class="fas fa-save me-2"></i>Create Bill
                            </button>
                        </div>
</form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleItemSelection(checkbox, index) {
        const quantityInput = document.getElementById('quantity-' + index);
        const itemCard = checkbox.closest('.item-card');
        
        if (checkbox.checked) {
            quantityInput.disabled = false;
            itemCard.classList.add('selected');
            updateSubtotal(index, parseFloat(checkbox.closest('.item-card').querySelector('.text-muted .fw-bold').textContent.replace('$', '')));
        } else {
            quantityInput.disabled = true;
            quantityInput.value = 1;
            itemCard.classList.remove('selected');
            document.getElementById('subtotal-' + index).textContent = '$0.00';
        }
        
        updateTotalAmount();
        updateSubmitButton();
    }
    
    function updateSubtotal(index, price) {
        const quantity = document.getElementById('quantity-' + index).value;
        const subtotal = price * quantity;
        document.getElementById('subtotal-' + index).textContent = '$' + subtotal.toFixed(2);
        updateTotalAmount();
    }
    
    function updateTotalAmount() {
        let total = 0;
        document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
            const index = checkbox.getAttribute('onchange').match(/\d+/)[0];
            const subtotalText = document.getElementById('subtotal-' + index).textContent;
            total += parseFloat(subtotalText.replace('$', ''));
        });
        document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
    }
    
    function updateSubmitButton() {
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = checkedItems.length === 0;
    }
    
    // Form validation
    document.getElementById('billForm').addEventListener('submit', function(e) {
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        if (checkedItems.length === 0) {
            e.preventDefault();
            alert('Please select at least one item to create a bill.');
            return false;
        }
        
        // Validate quantities
        let isValid = true;
        checkedItems.forEach(checkbox => {
            const index = checkbox.getAttribute('onchange').match(/\d+/)[0];
            const quantity = document.getElementById('quantity-' + index).value;
            if (quantity < 1) {
                isValid = false;
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please enter valid quantities for all selected items.');
            return false;
        }
    });
</script>

</body>
</html>

